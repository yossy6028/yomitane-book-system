import { Book } from '../types/Book';
import { bookService } from './bookService';
import { geminiRecommendationService } from './geminiRecommendationService';
import { TestResult } from '../data/mixedTestQuestions';

export interface UserProfile {
  age: number;
  interests: string[];
  readingLevel: 'å°å­¦æ ¡ä½å­¦å¹´' | 'å°å­¦æ ¡ä¸­å­¦å¹´' | 'å°å­¦æ ¡é«˜å­¦å¹´' | 'ä¸­å­¦ç”Ÿ' | 'ä¸­å­¦å—é¨“ãƒ¬ãƒ™ãƒ«' | 'é«˜æ ¡å—é¨“ãƒ¬ãƒ™ãƒ«';
  vocabularyScore: number; // 1-10 (ç·åˆãƒ¬ãƒ™ãƒ«)
  personalityTraits: string[]; // å‹‡æ•¢ã€å„ªã—ã„ã€å¥½å¥‡å¿ƒæ—ºç››ãªã©
  previousBooks?: string[]; // èª­ã‚“ã ã“ã¨ãŒã‚ã‚‹æœ¬ã®ID
  testResult?: TestResult; // è©³ç´°ãªãƒ†ã‚¹ãƒˆçµæœ
  testAnalysis?: {
    strengths: string[];
    weaknesses: string[];
    recommendations: string[];
  }; // ãƒ†ã‚¹ãƒˆçµæœåˆ†æ
}

export interface RecommendationResult {
  book: Book;
  score: number;
  reasons: string[];
  matchDetails: {
    ageMatch: boolean;
    interestMatch: string[];
    levelMatch: boolean;
    vocabularyMatch: boolean;
    personalityMatch: string[];
  };
}

class RecommendationService {
  
  // ãƒ¡ã‚¤ãƒ³æ¨è–¦æ©Ÿèƒ½ï¼ˆGemini APIå„ªå…ˆã€ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ä»˜ãï¼‰
  async getRecommendations(userProfile: UserProfile, maxResults: number = 5): Promise<RecommendationResult[]> {
    // Gemini APIãŒåˆ©ç”¨å¯èƒ½ãªå ´åˆã¯å„ªå…ˆä½¿ç”¨
    if (geminiRecommendationService.isConfigured()) {
      try {
        return await geminiRecommendationService.getRecommendations(userProfile, maxResults);
      } catch (error) {
        console.warn('Gemini API failed, falling back to local recommendation:', error);
        // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: ãƒ­ãƒ¼ã‚«ãƒ«æ¨è–¦ã‚·ã‚¹ãƒ†ãƒ ã‚’ä½¿ç”¨
        return this.getLocalRecommendations(userProfile, maxResults);
      }
    } else {
      // Gemini APIãŒè¨­å®šã•ã‚Œã¦ã„ãªã„å ´åˆã¯ãƒ­ãƒ¼ã‚«ãƒ«æ¨è–¦ã‚·ã‚¹ãƒ†ãƒ ã‚’ä½¿ç”¨
      return this.getLocalRecommendations(userProfile, maxResults);
    }
  }

  // ãƒ­ãƒ¼ã‚«ãƒ«æ¨è–¦ã‚·ã‚¹ãƒ†ãƒ ï¼ˆå…ƒã®ãƒ­ã‚¸ãƒƒã‚¯ï¼‰
  getLocalRecommendations(userProfile: UserProfile, maxResults: number = 5): RecommendationResult[] {
    const allBooks = bookService.getAllBooks();
    const scoredBooks: RecommendationResult[] = [];

    allBooks.forEach(book => {
      const recommendation = this.scoreBook(book, userProfile);
      if (recommendation.score > 0) {
        scoredBooks.push(recommendation);
      }
    });

    // ã‚¹ã‚³ã‚¢é †ã«ä¸¦ã³æ›¿ãˆ
    scoredBooks.sort((a, b) => b.score - a.score);
    
    // é‡è¤‡é™¤å»ï¼ˆæ—¢èª­æœ¬ã‚’é™¤å¤–ï¼‰
    const filteredBooks = scoredBooks.filter(rec => 
      !userProfile.previousBooks?.includes(rec.book.id)
    );

    return filteredBooks.slice(0, maxResults);
  }

  // å›³æ›¸ã‚¹ã‚³ã‚¢ãƒªãƒ³ã‚°
  private scoreBook(book: Book, profile: UserProfile): RecommendationResult {
    let score = 0;
    const reasons: string[] = [];
    const matchDetails = {
      ageMatch: false,
      interestMatch: [] as string[],
      levelMatch: false,
      vocabularyMatch: false,
      personalityMatch: [] as string[]
    };

    // 1. å¹´é½¢é©åˆæ€§ãƒã‚§ãƒƒã‚¯ (30ç‚¹æº€ç‚¹)
    const ageScore = this.calculateAgeScore(book, profile.age);
    score += ageScore;
    if (ageScore > 15) {
      matchDetails.ageMatch = true;
      reasons.push(`${profile.age}æ­³ã®${this.getAgeGroup(profile.age)}ã«ã´ã£ãŸã‚Šã®å†…å®¹`);
    } else if (ageScore > 0) {
      reasons.push(`å¹´é½¢çš„ã«å°‘ã—æŒ‘æˆ¦çš„ãªå†…å®¹`);
    }

    // 2. èˆˆå‘³åˆ†é‡ãƒãƒƒãƒãƒ³ã‚° (25ç‚¹æº€ç‚¹)
    const interestScore = this.calculateInterestScore(book, profile.interests);
    score += interestScore.score;
    matchDetails.interestMatch = interestScore.matches;
    interestScore.matches.forEach(interest => {
      reasons.push(`${interest}ãŒå¥½ããªãã¿ã«ãŠã™ã™ã‚`);
    });

    // 3. èª­æ›¸ãƒ¬ãƒ™ãƒ«é©åˆæ€§ (20ç‚¹æº€ç‚¹)
    const levelScore = this.calculateLevelScore(book, profile.readingLevel);
    score += levelScore;
    if (levelScore > 10) {
      matchDetails.levelMatch = true;
      reasons.push(`ãã¿ã®èª­æ›¸ãƒ¬ãƒ™ãƒ«ã«ã¡ã‚‡ã†ã©è‰¯ã„`);
    }

    // 4. èªå½™åŠ›é©åˆæ€§ (15ç‚¹æº€ç‚¹)
    const vocabularyScore = this.calculateVocabularyScore(book, profile.vocabularyScore);
    score += vocabularyScore;
    if (vocabularyScore > 7) {
      matchDetails.vocabularyMatch = true;
      reasons.push(`ãã¿ã®èªå½™åŠ›ã§æ¥½ã—ãèª­ã‚ã‚‹`);
    }

    // 5. æ€§æ ¼ç‰¹æ€§ãƒãƒƒãƒãƒ³ã‚° (10ç‚¹æº€ç‚¹)
    const personalityScore = this.calculatePersonalityScore(book, profile.personalityTraits);
    score += personalityScore.score;
    matchDetails.personalityMatch = personalityScore.matches;
    personalityScore.matches.forEach(trait => {
      reasons.push(`${trait}ãªãã¿ã®æ€§æ ¼ã«ãƒãƒƒãƒ`);
    });

    // ç†ç”±ãŒå°‘ãªã„å ´åˆã¯æœ¬ã®ç‰¹å¾´ã«åŸºã¥ã„ãŸç†ç”±ã‚’è¿½åŠ 
    if (reasons.length === 0) {
      reasons.push(this.generateFallbackReason(book, profile));
    }

    return {
      book,
      score,
      reasons,
      matchDetails
    };
  }

  // å¹´é½¢ã‚¹ã‚³ã‚¢è¨ˆç®—ï¼ˆå¼·åŒ–ç‰ˆï¼‰
  private calculateAgeScore(book: Book, userAge: number): number {
    const bookMinAge = book.ageRange.min;
    const bookMaxAge = book.ageRange.max;
    
    if (userAge >= bookMinAge && userAge <= bookMaxAge) {
      // å®Œå…¨ã«ãƒ¬ãƒ³ã‚¸å†… - å¹´é½¢ã«ã‚ˆã£ã¦ã•ã‚‰ã«ç´°ã‹ãèª¿æ•´
      const ageCenter = (bookMinAge + bookMaxAge) / 2;
      const distanceFromCenter = Math.abs(userAge - ageCenter);
      const maxDistance = (bookMaxAge - bookMinAge) / 2;
      
      if (distanceFromCenter === 0) {
        return 30; // ä¸­å¤®å€¤ãªã‚‰æœ€é«˜ç‚¹
      } else {
        return Math.max(25, 30 - (distanceFromCenter / maxDistance) * 5);
      }
    } else if (userAge === bookMinAge - 1 || userAge === bookMaxAge + 1) {
      // 1æ­³å·®
      return 18;
    } else if (userAge === bookMinAge - 2 || userAge === bookMaxAge + 2) {
      // 2æ­³å·®
      return 8;
    } else if (userAge === bookMinAge - 3 || userAge === bookMaxAge + 3) {
      // 3æ­³å·®
      return 3;
    } else {
      // ãã‚Œä»¥ä¸Šã®å·®
      return 0;
    }
  }

  // èˆˆå‘³åˆ†é‡ã‚¹ã‚³ã‚¢è¨ˆç®—
  private calculateInterestScore(book: Book, userInterests: string[]): { score: number, matches: string[] } {
    const matches: string[] = [];
    let score = 0;

    userInterests.forEach(userInterest => {
      if (book.interests.includes(userInterest)) {
        matches.push(userInterest);
        score += 8; // ä¸€è‡´ã™ã‚‹èˆˆå‘³ã”ã¨ã«8ç‚¹
      }
    });

    // ã‚«ãƒ†ã‚´ãƒªã¨ã®éƒ¨åˆ†ãƒãƒƒãƒã‚‚ãƒã‚§ãƒƒã‚¯
    const categoryMatches = this.findCategoryMatches(book.categories, userInterests);
    categoryMatches.forEach(match => {
      if (!matches.includes(match)) {
        matches.push(match);
        score += 3; // ã‚«ãƒ†ã‚´ãƒªãƒãƒƒãƒã¯3ç‚¹
      }
    });

    return { score: Math.min(score, 25), matches }; // æœ€å¤§25ç‚¹
  }

  // ã‚«ãƒ†ã‚´ãƒªãƒãƒƒãƒãƒ³ã‚°
  private findCategoryMatches(categories: string[], userInterests: string[]): string[] {
    const matches: string[] = [];
    const categoryMapping: { [key: string]: string[] } = {
      'ã‚¹ãƒãƒ¼ãƒ„': ['ã‚¹ãƒãƒ¼ãƒ„', 'ç«¶æŠ€', 'é‹å‹•'],
      'éŸ³æ¥½': ['éŸ³æ¥½', 'æ¥½å™¨', 'æ­Œ'],
      'çµµã‚’æã': ['çµµ', 'ç¾è¡“', 'ã‚¢ãƒ¼ãƒˆ'],
      'ã‚²ãƒ¼ãƒ ': ['ã‚²ãƒ¼ãƒ ', 'éŠã³'],
      'å‹•ç‰©': ['å‹•ç‰©', 'ç”Ÿãç‰©', 'ãƒšãƒƒãƒˆ'],
      'ç§‘å­¦': ['ç§‘å­¦', 'ã‚µã‚¤ã‚¨ãƒ³ã‚¹', 'å®Ÿé¨“', 'å­¦ç¿’'],
      'æ–™ç†': ['æ–™ç†', 'é£Ÿã¹ç‰©', 'é£Ÿäº‹'],
      'å†’é™º': ['å†’é™º', 'ã‚¢ãƒ‰ãƒ™ãƒ³ãƒãƒ£ãƒ¼', 'æ—…'],
      'èª­æ›¸': ['èª­æ›¸', 'æœ¬', 'æ–‡å­¦'],
      'æ˜ ç”»ãƒ»ã‚¢ãƒ‹ãƒ¡': ['æ˜ ç”»', 'ã‚¢ãƒ‹ãƒ¡', 'æ˜ åƒ'],
      'å·¥ä½œãƒ»æ‰‹èŠ¸': ['å·¥ä½œ', 'æ‰‹èŠ¸', 'ä½œã‚‹'],
      'æ­´å²': ['æ­´å²', 'æ˜”', 'æ™‚ä»£'],
      'å®‡å®™ãƒ»å¤©ä½“': ['å®‡å®™', 'æ˜Ÿ', 'å¤©ä½“', 'æƒ‘æ˜Ÿ'],
      'ä¹—ã‚Šç‰©': ['è»Š', 'é›»è»Š', 'é£›è¡Œæ©Ÿ', 'èˆ¹'],
      'æ—…è¡Œãƒ»åœ°ç†': ['æ—…è¡Œ', 'åœ°ç†', 'ä¸–ç•Œ', 'å›½'],
      'æ¨ç†ãƒ»è¬è§£ã': ['æ¨ç†', 'ãƒŸã‚¹ãƒ†ãƒªãƒ¼', 'è¬è§£ã'],
      'ãƒ•ã‚¡ãƒ³ã‚¿ã‚¸ãƒ¼': ['ãƒ•ã‚¡ãƒ³ã‚¿ã‚¸ãƒ¼', 'é­”æ³•', 'ä¸æ€è­°'],
      'å‹æƒ…ãƒ»æ‹æ„›': ['å‹æƒ…', 'æ‹æ„›', 'å‹é”'],
      'å®¶æ—': ['å®¶æ—', 'è¦ª', 'å…„å¼Ÿ'],
      'å­¦æ ¡ç”Ÿæ´»': ['å­¦æ ¡', 'æ•™å®¤', 'å…ˆç”Ÿ', 'å‹‰å¼·'],
      'ãƒ¦ãƒ¼ãƒ¢ã‚¢': ['ãƒ¦ãƒ¼ãƒ¢ã‚¢', 'ç¬‘ã„', 'é¢ç™½ã„']
    };

    userInterests.forEach(interest => {
      categories.forEach(category => {
        const keywords = categoryMapping[interest] || [interest];
        if (keywords.some(keyword => category.includes(keyword))) {
          matches.push(interest);
        }
      });
    });

    return matches;
  }

  // èª­æ›¸ãƒ¬ãƒ™ãƒ«ã‚¹ã‚³ã‚¢è¨ˆç®—ï¼ˆæ–°ãƒ¬ãƒ™ãƒ«ã‚·ã‚¹ãƒ†ãƒ å¯¾å¿œï¼‰
  private calculateLevelScore(book: Book, userLevel: 'å°å­¦æ ¡ä½å­¦å¹´' | 'å°å­¦æ ¡ä¸­å­¦å¹´' | 'å°å­¦æ ¡é«˜å­¦å¹´' | 'ä¸­å­¦ç”Ÿ' | 'ä¸­å­¦å—é¨“ãƒ¬ãƒ™ãƒ«' | 'é«˜æ ¡å—é¨“ãƒ¬ãƒ™ãƒ«'): number {
    const levelPoints = { 
      'å°å­¦æ ¡ä½å­¦å¹´': 1, 
      'å°å­¦æ ¡ä¸­å­¦å¹´': 2, 
      'å°å­¦æ ¡é«˜å­¦å¹´': 3, 
      'ä¸­å­¦ç”Ÿ': 4,
      'ä¸­å­¦å—é¨“ãƒ¬ãƒ™ãƒ«': 5,
      'é«˜æ ¡å—é¨“ãƒ¬ãƒ™ãƒ«': 6
    };
    const userPoints = levelPoints[userLevel];
    const bookPoints = levelPoints[book.readingLevel as keyof typeof levelPoints] || 3;

    if (userPoints === bookPoints) {
      return 20; // å®Œå…¨ä¸€è‡´
    } else if (Math.abs(userPoints - bookPoints) === 1) {
      return 12; // 1ãƒ¬ãƒ™ãƒ«å·®
    } else if (Math.abs(userPoints - bookPoints) === 2) {
      return 6; // 2ãƒ¬ãƒ™ãƒ«å·®
    } else {
      return 2; // 3ãƒ¬ãƒ™ãƒ«å·®ä»¥ä¸Š
    }
  }

  // èªå½™åŠ›ã‚¹ã‚³ã‚¢è¨ˆç®—
  private calculateVocabularyScore(book: Book, userVocabularyScore: number): number {
    const difference = Math.abs(book.vocabularyLevel - userVocabularyScore);
    
    if (difference === 0) {
      return 15;
    } else if (difference === 1) {
      return 12;
    } else if (difference === 2) {
      return 8;
    } else if (difference === 3) {
      return 4;
    } else {
      return 0;
    }
  }

  // æ€§æ ¼ç‰¹æ€§ã‚¹ã‚³ã‚¢è¨ˆç®—
  private calculatePersonalityScore(book: Book, userTraits: string[]): { score: number, matches: string[] } {
    const matches: string[] = [];
    let score = 0;

    // æœ¬ã®èˆˆå‘³åˆ†é‡ã¨æ€§æ ¼ç‰¹æ€§ã®ãƒãƒƒãƒ”ãƒ³ã‚°
    const traitMapping: { [key: string]: string[] } = {
      'å‹‡æ•¢': ['å†’é™º', 'æˆ¦ã„', 'ãƒ’ãƒ¼ãƒ­ãƒ¼'],
      'å„ªã—ã„': ['å‹æƒ…ãƒ»æ‹æ„›', 'å®¶æ—', 'æ„›æƒ…', 'å‹•ç‰©'],
      'å¥½å¥‡å¿ƒæ—ºç››': ['ç§‘å­¦', 'å­¦ç¿’', 'ç™ºè¦‹', 'æ¢æ¤œ', 'å®‡å®™ãƒ»å¤©ä½“'],
      'æ´»ç™º': ['ã‚¹ãƒãƒ¼ãƒ„', 'é‹å‹•', 'ç«¶æŠ€', 'å†’é™º'],
      'èŠ¸è¡“çš„': ['éŸ³æ¥½', 'çµµã‚’æã', 'å‰µä½œ', 'å·¥ä½œãƒ»æ‰‹èŠ¸'],
      'æ€ã„ã‚„ã‚Š': ['å‹•ç‰©', 'ãƒšãƒƒãƒˆ', 'å‹æƒ…ãƒ»æ‹æ„›', 'å®¶æ—'],
      'è«–ç†çš„': ['æ¨ç†ãƒ»è¬è§£ã', 'ç§‘å­¦', 'æ­´å²'],
      'ãƒ¦ãƒ¼ãƒ¢ã‚¢å¥½ã': ['ãƒ¦ãƒ¼ãƒ¢ã‚¢', 'ç¬‘ã„', 'ã‚³ãƒ¡ãƒ‡ã‚£'],
      'æ…é‡': ['æ¨ç†ãƒ»è¬è§£ã', 'æ­´å²', 'èª­æ›¸'],
      'ç¤¾äº¤çš„': ['å‹æƒ…ãƒ»æ‹æ„›', 'å­¦æ ¡ç”Ÿæ´»', 'ã‚¹ãƒãƒ¼ãƒ„'],
      'å†…å‘çš„': ['èª­æ›¸', 'çµµã‚’æã', 'éŸ³æ¥½', 'å·¥ä½œãƒ»æ‰‹èŠ¸'],
      'å‰µé€ çš„': ['çµµã‚’æã', 'éŸ³æ¥½', 'å·¥ä½œãƒ»æ‰‹èŠ¸', 'ãƒ•ã‚¡ãƒ³ã‚¿ã‚¸ãƒ¼'],
      'è²¬ä»»æ„ŸãŒå¼·ã„': ['å®¶æ—', 'å­¦æ ¡ç”Ÿæ´»', 'æ­´å²'],
      'è‡ªç«‹ã—ã¦ã„ã‚‹': ['å†’é™º', 'æ—…è¡Œãƒ»åœ°ç†', 'ç§‘å­¦'],
      'å”èª¿æ€§ãŒã‚ã‚‹': ['å‹æƒ…ãƒ»æ‹æ„›', 'å­¦æ ¡ç”Ÿæ´»', 'ã‚¹ãƒãƒ¼ãƒ„'],
      'ãƒªãƒ¼ãƒ€ãƒ¼ã‚·ãƒƒãƒ—ãŒã‚ã‚‹': ['å†’é™º', 'ã‚¹ãƒãƒ¼ãƒ„', 'å­¦æ ¡ç”Ÿæ´»'],
      'æ„Ÿå—æ€§ãŒè±Šã‹': ['éŸ³æ¥½', 'çµµã‚’æã', 'æ˜ ç”»ãƒ»ã‚¢ãƒ‹ãƒ¡', 'ãƒ•ã‚¡ãƒ³ã‚¿ã‚¸ãƒ¼'],
      'é›†ä¸­åŠ›ãŒã‚ã‚‹': ['èª­æ›¸', 'æ¨ç†ãƒ»è¬è§£ã', 'ç§‘å­¦', 'ã‚²ãƒ¼ãƒ '],
      'å†’é™ºå¥½ã': ['å†’é™º', 'æ—…è¡Œãƒ»åœ°ç†', 'å®‡å®™ãƒ»å¤©ä½“'],
      'å¹³å’Œä¸»ç¾©': ['å®¶æ—', 'å‹æƒ…ãƒ»æ‹æ„›', 'å‹•ç‰©', 'è‡ªç„¶']
    };

    userTraits.forEach(trait => {
      const relatedInterests = traitMapping[trait] || [];
      const hasMatch = relatedInterests.some(interest => 
        book.interests.some(bookInterest => bookInterest.includes(interest))
      );
      
      if (hasMatch) {
        matches.push(trait);
        score += 5;
      }
    });

    return { score: Math.min(score, 10), matches };
  }

  // å¹´é½¢åˆ¥ãŠã™ã™ã‚å›³æ›¸ï¼ˆGemini APIå¯¾å¿œï¼‰
  async getAgeBasedRecommendations(age: number): Promise<Book[]> {
    if (geminiRecommendationService.isConfigured()) {
      try {
        return await geminiRecommendationService.getAgeBasedRecommendations(age, 3);
      } catch (error) {
        console.warn('Gemini API failed for age-based recommendations, using local method:', error);
      }
    }
    
    // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: ãƒ­ãƒ¼ã‚«ãƒ«å‡¦ç†
    const allBooks = bookService.getAllBooks();
    return allBooks
      .filter(book => age >= book.ageRange.min && age <= book.ageRange.max)
      .sort((a, b) => b.rating - a.rating)
      .slice(0, 3);
  }

  // èˆˆå‘³åˆ¥ãŠã™ã™ã‚å›³æ›¸ï¼ˆGemini APIå¯¾å¿œï¼‰
  async getInterestBasedRecommendations(interests: string[]): Promise<Book[]> {
    if (geminiRecommendationService.isConfigured()) {
      try {
        return await geminiRecommendationService.getInterestBasedRecommendations(interests, 3);
      } catch (error) {
        console.warn('Gemini API failed for interest-based recommendations, using local method:', error);
      }
    }
    
    // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: ãƒ­ãƒ¼ã‚«ãƒ«å‡¦ç†
    const allBooks = bookService.getAllBooks();
    const scoredBooks = allBooks.map(book => {
      const matchCount = interests.filter(interest => 
        book.interests.includes(interest)
      ).length;
      return { book, score: matchCount };
    });

    return scoredBooks
      .filter(item => item.score > 0)
      .sort((a, b) => b.score - a.score)
      .map(item => item.book)
      .slice(0, 3);
  }

  // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ç†ç”±ç”Ÿæˆï¼ˆæœ¬ã®ç‰¹å¾´ã«åŸºã¥ãï¼‰
  private generateFallbackReason(book: Book, profile: UserProfile): string {
    const fallbackReasons = [
      `${book.author}ã•ã‚“ã®äººæ°—ä½œå“`,
      `è©•ä¾¡${book.rating}ç‚¹ã®è‰¯æ›¸`,
      `${book.categories[0]}ã‚¸ãƒ£ãƒ³ãƒ«ã®ä»£è¡¨ä½œ`,
      `èª­ã¿å¿œãˆã®ã‚ã‚‹ç‰©èª`,
      `${book.ageRange.min}-${book.ageRange.max}æ­³ã«äººæ°—ã®ä¸€å†Š`,
      'èª­æ›¸ã®å¹…ãŒåºƒãŒã‚‹è‰¯ã„ä½œå“',
      'æ–°ã—ã„ã‚¸ãƒ£ãƒ³ãƒ«ã¸ã®å…¥é–€æ›¸ã¨ã—ã¦æœ€é©',
      'ã˜ã£ãã‚Šæ¥½ã—ã‚ã‚‹ä½œå“',
      'å¿ƒã«æ®‹ã‚‹ç´ æ•µãªãŠè©±'
    ];
    
    // æœ¬ã®IDã¨ãƒ¦ãƒ¼ã‚¶ãƒ¼å¹´é½¢ã«åŸºã¥ã„ã¦æ±ºå®šè«–çš„ã«é¸æŠï¼ˆä¸€è²«æ€§ã‚’ä¿ã¡ã¤ã¤å¤šæ§˜æ€§ç¢ºä¿ï¼‰
    const reasonIndex = (book.id.charCodeAt(0) + profile.age) % fallbackReasons.length;
    return fallbackReasons[reasonIndex];
  }

  // å¹´é½¢ã‚°ãƒ«ãƒ¼ãƒ—å–å¾—ãƒ˜ãƒ«ãƒ‘ãƒ¼
  private getAgeGroup(age: number): string {
    if (age <= 8) return 'å°ã•ãªãŠå­æ§˜';
    if (age <= 12) return 'ã—ã‚‡ã†ãŒãã›ã„';
    if (age <= 15) return 'ã¡ã‚…ã†ãŒãã›ã„';
    return 'ã“ã†ã“ã†ã›ã„';
  }

  // æ¨è–¦ç†ç”±ã®è©³ç´°ç”Ÿæˆ
  generateDetailedReason(recommendation: RecommendationResult, userProfile: UserProfile): string {
    const { book, matchDetails } = recommendation;
    let detailedReason = `ã€Œ${book.title}ã€ãŒã‚ãªãŸã«ãŠã™ã™ã‚ã®ç†ç”±ï¼š\n\n`;

    // å¹´é½¢é©åˆæ€§
    if (matchDetails.ageMatch) {
      detailedReason += `âœ… ${userProfile.age}æ­³ã®ãã¿ã«ã´ã£ãŸã‚Šã®å†…å®¹ãƒ¬ãƒ™ãƒ«\n`;
    }

    // èˆˆå‘³ãƒãƒƒãƒ
    if (matchDetails.interestMatch.length > 0) {
      detailedReason += `ğŸ¯ ãã¿ãŒå¥½ããªã€Œ${matchDetails.interestMatch.join('ãƒ»')}ã€ã®è¦ç´ ãŒå«ã¾ã‚Œã¦ã„ã‚‹\n`;
    }

    // èª­æ›¸ãƒ¬ãƒ™ãƒ«
    if (matchDetails.levelMatch) {
      const levelLabels = {
        'å°å­¦æ ¡ä½å­¦å¹´': 'ä½å­¦å¹´å‘ã‘',
        'å°å­¦æ ¡ä¸­å­¦å¹´': 'ä¸­å­¦å¹´å‘ã‘',
        'å°å­¦æ ¡é«˜å­¦å¹´': 'é«˜å­¦å¹´å‘ã‘',
        'ä¸­å­¦ç”Ÿ': 'ä¸­å­¦ç”Ÿå‘ã‘',
        'ä¸­å­¦å—é¨“ãƒ¬ãƒ™ãƒ«': 'ä¸­å­¦å—é¨“ãƒ¬ãƒ™ãƒ«',
        'é«˜æ ¡å—é¨“ãƒ¬ãƒ™ãƒ«': 'é«˜æ ¡å—é¨“ãƒ¬ãƒ™ãƒ«'
      };
      detailedReason += `ğŸ“š ã€Œ${levelLabels[userProfile.readingLevel]}ã€ãƒ¬ãƒ™ãƒ«ã§æ¥½ã—ãèª­ã‚ã‚‹\n`;
    }

    // æ€§æ ¼ç‰¹æ€§
    if (matchDetails.personalityMatch.length > 0) {
      detailedReason += `ğŸ’ª ã€Œ${matchDetails.personalityMatch.join('ãƒ»')}ã€ãªãã¿ã®æ€§æ ¼ã«ã‚ˆãåˆã†\n`;
    }

    // æœ¬ã®è©³ç´°æƒ…å ±
    detailedReason += `\nğŸ“– æœ¬ã®æƒ…å ±ï¼š\n`;
    detailedReason += `è‘—è€…ï¼š${book.author}\n`;
    detailedReason += `è©•ä¾¡ï¼š${'â­'.repeat(Math.floor(book.rating))} (${book.rating})\n`;
    if (book.pageCount) {
      detailedReason += `ãƒšãƒ¼ã‚¸æ•°ï¼šç´„${book.pageCount}ãƒšãƒ¼ã‚¸\n`;
    }

    return detailedReason;
  }
}

export const recommendationService = new RecommendationService();
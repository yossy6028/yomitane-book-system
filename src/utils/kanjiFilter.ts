export interface KanjiFilterOptions {
  gradeLevel: number; // 1-6 for elementary grades, 7+ for middle school
  allowHiragana: boolean;
  allowKatakana: boolean;
  strictMode: boolean; // true = convert non-grade kanji to hiragana
}

// Grade-level kanji data based on Japanese Ministry of Education guidelines
const GRADE_KANJI: { [grade: number]: string[] } = {
  1: ['一', '右', '雨', '円', '王', '音', '下', '火', '花', '貝', '学', '気', '九', '休', '玉', '金', '空', '月', '犬', '見', '五', '口', '校', '左', '三', '山', '子', '四', '糸', '字', '耳', '七', '車', '手', '十', '出', '女', '小', '上', '森', '人', '水', '正', '生', '青', '夕', '石', '赤', '千', '川', '先', '早', '草', '足', '村', '大', '男', '竹', '中', '虫', '町', '天', '田', '土', '二', '日', '入', '年', '白', '八', '百', '文', '木', '本', '名', '目', '立', '力', '林', '六'],
  2: ['引', '羽', '雲', '園', '遠', '何', '科', '夏', '家', '歌', '画', '回', '会', '海', '絵', '外', '角', '楽', '活', '間', '丸', '岩', '顔', '汽', '記', '帰', '弓', '牛', '魚', '京', '強', '教', '近', '兄', '形', '計', '元', '言', '原', '戸', '古', '午', '後', '語', '工', '公', '広', '交', '光', '考', '行', '高', '黄', '合', '谷', '国', '黒', '今', '才', '細', '作', '算', '止', '市', '矢', '姉', '思', '紙', '寺', '自', '時', '室', '社', '弱', '首', '秋', '週', '春', '書', '少', '場', '色', '食', '心', '新', '親', '図', '数', '西', '声', '星', '晴', '切', '雪', '船', '線', '前', '組', '走', '多', '太', '体', '台', '地', '池', '知', '茶', '昼', '長', '鳥', '朝', '直', '通', '弟', '店', '点', '電', '刀', '冬', '当', '東', '答', '頭', '同', '道', '読', '内', '南', '肉', '馬', '売', '買', '麦', '半', '番', '父', '風', '分', '聞', '米', '歩', '母', '方', '北', '毎', '妹', '万', '明', '鳴', '毛', '門', '夜', '野', '友', '用', '曜', '来', '里', '理', '話'],
  3: ['悪', '安', '暗', '医', '委', '意', '育', '員', '院', '飲', '運', '泳', '駅', '央', '横', '屋', '温', '化', '荷', '界', '開', '階', '寒', '感', '漢', '館', '岸', '起', '期', '客', '究', '急', '級', '宮', '球', '去', '橋', '業', '曲', '局', '銀', '区', '苦', '具', '君', '係', '軽', '血', '決', '研', '県', '庫', '湖', '向', '幸', '港', '号', '根', '祭', '皿', '仕', '死', '使', '始', '指', '歯', '詩', '次', '事', '持', '式', '実', '写', '者', '主', '守', '取', '酒', '受', '州', '拾', '終', '習', '集', '住', '重', '宿', '所', '暑', '助', '昭', '消', '商', '章', '勝', '乗', '植', '申', '身', '神', '真', '深', '進', '世', '整', '昔', '全', '相', '送', '想', '息', '速', '族', '他', '打', '対', '待', '代', '第', '題', '炭', '短', '談', '着', '注', '柱', '丁', '帳', '調', '追', '定', '庭', '笛', '鉄', '転', '都', '度', '投', '豆', '島', '湯', '登', '等', '動', '童', '農', '波', '配', '倍', '箱', '畑', '発', '反', '坂', '板', '皮', '悲', '美', '鼻', '筆', '氷', '表', '秒', '病', '品', '負', '部', '服', '福', '物', '平', '返', '勉', '放', '味', '命', '面', '問', '役', '薬', '由', '油', '有', '遊', '予', '羊', '洋', '葉', '陽', '様', '落', '流', '旅', '両', '緑', '礼', '列', '練', '路', '和'],
  4: ['愛', '案', '以', '衣', '位', '囲', '胃', '印', '英', '栄', '塩', '億', '加', '果', '貨', '課', '芽', '改', '械', '害', '街', '各', '覚', '完', '官', '管', '関', '観', '願', '希', '季', '紀', '喜', '旗', '器', '機', '議', '求', '泣', '救', '給', '挙', '漁', '共', '協', '鏡', '競', '極', '訓', '軍', '郡', '径', '型', '景', '芸', '欠', '結', '建', '健', '験', '固', '功', '好', '候', '航', '康', '告', '差', '菜', '最', '材', '昨', '札', '刷', '殺', '察', '参', '産', '散', '残', '士', '氏', '史', '司', '試', '児', '治', '辞', '失', '借', '種', '周', '祝', '順', '初', '松', '笑', '唱', '焼', '象', '照', '賞', '臣', '信', '成', '省', '清', '静', '席', '積', '折', '節', '説', '浅', '戦', '選', '然', '争', '倉', '巣', '束', '側', '続', '卒', '孫', '帯', '隊', '達', '単', '置', '仲', '貯', '兆', '腸', '低', '底', '停', '的', '典', '伝', '徒', '努', '灯', '堂', '働', '特', '得', '毒', '熱', '念', '敗', '梅', '博', '飯', '飛', '費', '必', '票', '標', '不', '夫', '付', '府', '副', '粉', '兵', '別', '辺', '変', '便', '包', '法', '望', '牧', '末', '満', '未', '脈', '民', '無', '約', '勇', '要', '養', '浴', '利', '陸', '良', '料', '量', '輪', '類', '令', '冷', '例', '歴', '連', '老', '労', '録'],
  5: ['圧', '移', '因', '永', '営', '衛', '易', '益', '液', '演', '応', '往', '桜', '恩', '可', '仮', '価', '河', '過', '賀', '快', '解', '格', '確', '額', '刊', '幹', '慣', '眼', '基', '寄', '規', '技', '義', '逆', '久', '旧', '居', '許', '境', '均', '禁', '句', '群', '経', '潔', '件', '券', '険', '検', '限', '現', '減', '故', '個', '護', '効', '厚', '耕', '鉱', '構', '興', '講', '混', '査', '再', '災', '妻', '採', '際', '在', '財', '罪', '雑', '酸', '賛', '支', '志', '枝', '師', '資', '飼', '示', '似', '識', '質', '舎', '謝', '授', '修', '述', '術', '準', '序', '招', '承', '証', '条', '状', '常', '情', '織', '職', '制', '性', '政', '勢', '精', '製', '税', '責', '績', '接', '設', '舌', '絶', '銭', '祖', '素', '総', '造', '像', '増', '則', '測', '属', '率', '損', '退', '貸', '態', '団', '断', '築', '張', '提', '程', '適', '敵', '統', '銅', '導', '徳', '独', '任', '燃', '能', '破', '犯', '判', '版', '比', '肥', '非', '備', '俵', '評', '貧', '布', '婦', '富', '武', '復', '複', '仏', '編', '弁', '保', '墓', '報', '豊', '防', '貿', '暴', '務', '夢', '迷', '綿', '輸', '余', '預', '容', '略', '留', '領'],
  6: ['異', '遺', '域', '宇', '映', '延', '沿', '我', '灰', '拡', '革', '閣', '割', '株', '干', '巻', '看', '簡', '危', '机', '揮', '貴', '疑', '吸', '供', '胸', '郷', '勤', '筋', '系', '敬', '警', '劇', '激', '穴', '絹', '権', '憲', '源', '厳', '己', '呼', '誤', '后', '孝', '皇', '紅', '降', '鋼', '刻', '穀', '骨', '困', '砂', '座', '済', '裁', '策', '冊', '蚕', '至', '私', '姿', '視', '詞', '誌', '磁', '射', '捨', '尺', '若', '樹', '収', '宗', '就', '衆', '従', '縦', '縮', '熟', '純', '処', '署', '諸', '除', '将', '傷', '障', '城', '蒸', '針', '仁', '垂', '推', '寸', '盛', '聖', '誠', '宣', '専', '泉', '洗', '染', '善', '奏', '窓', '創', '装', '層', '操', '蔵', '臓', '存', '尊', '宅', '担', '探', '誕', '段', '暖', '値', '宙', '忠', '著', '庁', '頂', '潮', '賃', '痛', '展', '討', '党', '糖', '届', '難', '乳', '認', '納', '脳', '派', '拝', '背', '肺', '俳', '班', '晩', '否', '批', '秘', '腹', '奮', '並', '陛', '閉', '片', '補', '暮', '宝', '訪', '亡', '忘', '棒', '枚', '幕', '密', '盟', '模', '訳', '郵', '優', '幼', '欲', '翌', '乱', '卵', '覧', '裏', '律', '臨', '朗', '論']
};

// Common kanji to hiragana conversions for reading assistance
const KANJI_TO_HIRAGANA: { [kanji: string]: string } = {
  '電車': 'でんしゃ',
  '図書館': 'としょかん',
  '動物': 'どうぶつ',
  '学校': 'がっこう',
  '友達': 'ともだち',
  '先生': 'せんせい',
  '勉強': 'べんきょう',
  '音楽': 'おんがく',
  '美術': 'びじゅつ',
  '体育': 'たいいく',
  '理科': 'りか',
  '社会': 'しゃかい',
  '数学': 'すうがく',
  '国語': 'こくご',
  '歴史': 'れきし',
  '地理': 'ちり',
  '政治': 'せいじ',
  '経済': 'けいざい',
  '文化': 'ぶんか',
  '自然': 'しぜん',
  '科学': 'かがく',
  '技術': 'ぎじゅつ',
  '芸術': 'げいじゅつ',
  '運動': 'うんどう',
  '健康': 'けんこう',
  '平和': 'へいわ',
  '協力': 'きょうりょく',
  '努力': 'どりょく',
  '成功': 'せいこう',
  '失敗': 'しっぱい',
  '困難': 'こんなん',
  '簡単': 'かんたん',
  '複雑': 'ふくざつ',
  '重要': 'じゅうよう',
  '必要': 'ひつよう',
  '特別': 'とくべつ',
  '一般': 'いっぱん',
  '普通': 'ふつう',
  '特殊': 'とくしゅ',
  '基本': 'きほん',
  '応用': 'おうよう',
  '発展': 'はってん',
  '進歩': 'しんぽ',
  '改良': 'かいりょう',
  '改善': 'かいぜん',
  '工夫': 'くふう',
  '研究': 'けんきゅう',
  '実験': 'じっけん',
  '観察': 'かんさつ',
  '発見': 'はっけん',
  '発明': 'はつめい',
  '創造': 'そうぞう',
  '理解': 'りかい',
  '説明': 'せつめい',
  '質問': 'しつもん',
  '答え': 'こたえ',
  '問題': 'もんだい',
  '解決': 'かいけつ',
  '方法': 'ほうほう',
  '手段': 'しゅだん',
  '道具': 'どうぐ',
  '材料': 'ざいりょう',
  '資料': 'しりょう',
  '情報': 'じょうほう',
  '知識': 'ちしき',
  '経験': 'けいけん',
  '感情': 'かんじょう',
  '気持ち': 'きもち',
  '気分': 'きぶん',
  '心配': 'しんぱい',
  '安心': 'あんしん',
  '満足': 'まんぞく',
  '不満': 'ふまん',
  '幸福': 'こうふく',
  '不幸': 'ふこう',
  '楽しい': 'たのしい',
  '面白い': 'おもしろい',
  'つまらない': 'つまらない',
  '美しい': 'うつくしい',
  '汚い': 'きたない',
  '大切': 'たいせつ',
  '大事': 'だいじ',
  '価値': 'かち',
  '意味': 'いみ',
  '目的': 'もくてき',
  '理由': 'りゆう',
  '原因': 'げんいん',
  '結果': 'けっか',
  '影響': 'えいきょう',
  '効果': 'こうか',
  '利益': 'りえき',
  '損失': 'そんしつ',
  '危険': 'きけん',
  '安全': 'あんぜん',
  '注意': 'ちゅうい',
  '警告': 'けいこく',
  '約束': 'やくそく',
  '責任': 'せきにん',
  '義務': 'ぎむ',
  '権利': 'けんり',
  '自由': 'じゆう',
  '平等': 'びょうどう',
  '公平': 'こうへい',
  '正義': 'せいぎ',
  '正直': 'しょうじき',
  '嘘': 'うそ',
  '真実': 'しんじつ',
  '事実': 'じじつ',
  '現実': 'げんじつ',
  '理想': 'りそう',
  '夢': 'ゆめ',
  '希望': 'きぼう',
  '願い': 'ねがい',
  '目標': 'もくひょう',
  '計画': 'けいかく',
  '予定': 'よてい',
  '準備': 'じゅんび',
  '用意': 'ようい',
  '練習': 'れんしゅう',
  '復習': 'ふくしゅう',
  '予習': 'よしゅう',
  '宿題': 'しゅくだい',
  '授業': 'じゅぎょう',
  '講義': 'こうぎ',
  '指導': 'しどう',
  '教育': 'きょういく',
  '学習': 'がくしゅう',
  '成績': 'せいせき',
  '評価': 'ひょうか',
  '判断': 'はんだん',
  '決定': 'けってい',
  '選択': 'せんたく',
  '比較': 'ひかく',
  '検討': 'けんとう',
  '考慮': 'こうりょ',
  '配慮': 'はいりょ',
  '注目': 'ちゅうもく',
  '関心': 'かんしん',
  '興味': 'きょうみ',
  '好奇心': 'こうきしん',
  '探究心': 'たんきゅうしん',
  '向上心': 'こうじょうしん',
  '責任感': 'せきにんかん',
  '使命感': 'しめいかん',
  '達成感': 'たっせいかん',
  '満足感': 'まんぞくかん',
  '充実感': 'じゅうじつかん',
  '安定感': 'あんていかん',
  '不安感': 'ふあんかん',
  '緊張感': 'きんちょうかん',
  '危機感': 'ききかん',
  '切迫感': 'せっぱくかん',
  // 常識問題でよく使われる語彙を追加
  '困っている': 'こまっている',
  '手伝う': 'てつだう',
  '薬': 'くすり',
  '野菜': 'やさい',
  '消しゴム': 'けしゴム',
  '給食': 'きゅうしょく',
  'ゴミ箱': 'ゴミばこ',
  '蛇口': 'じゃぐち',
  '朝ごはん': 'あさごはん',
  '公共': 'こうきょう',
  '迷惑': 'めいわく',
  'エレベーター': 'エレベーター',
  '敬語': 'けいご',
  '謝罪': 'しゃざい',
  '素直': 'すなお',
  '友情': 'ゆうじょう',
  '信頼': 'しんらい',
  '税金': 'ぜいきん',
  '選挙': 'せんきょ',
  '法律': 'ほうりつ',
  '民主主義': 'みんしゅしゅぎ',
  'マナー': 'マナー',
  '他人': 'たにん',
  '振る舞う': 'ふるまう',
  '食事': 'しょくじ',
  '目上': 'めうえ',
  'ため口': 'ためぐち',
  'アドバイス': 'アドバイス',
  '励ます': 'はげます',
  '慰める': 'なぐさめる',
  '批判': 'ひはん',
  '否定': 'ひてい',
  '無視': 'むし',
  '反省': 'はんせい',
  '誇らしい': 'ほこらしい',
  'チームワーク': 'チームワーク',
  '協調性': 'きょうちょうせい',
  '他人任せ': 'たにんまかせ',
  '基本的': 'きほんてき',
  '時には': 'ときには',
  '問題ない': 'もんだいない',
  '信頼関係': 'しんらいかんけい',
  '都合': 'つごう',
  '互い': 'たがい',
  '許可': 'きょか',
  '勝手': 'かって',
  '面倒': 'めんどう',
  '素晴らしい': 'すばらしい',
  '損': 'そん',
  '財源': 'ざいげん',
  'サービス': 'サービス',
  '道路': 'どうろ',
  '代表者': 'だいひょうしゃ',
  '国民': 'こくみん',
  '制度': 'せいど',
  '秩序': 'ちつじょ',
  '職業': 'しょくぎょう',
  '貴賤': 'きせん',
  '支配': 'しはい',
  '話し合い': 'はなしあい',
  '横断歩道': 'おうだんほどう',
  '信号': 'しんごう',
  '早寝早起き': 'はやねはやおき',
  '見て見ぬふり': 'みてみぬふり',
  'バランス': 'バランス',
  '季節': 'きせつ',
  '行事': 'ぎょうじ',
  'お正月': 'おしょうがつ',
  'おせち料理': 'おせちりょうり',
  'クリスマス': 'クリスマス',
  'バーベキュー': 'バーベキュー',
  '海水浴': 'かいすいよく',
  '運動会': 'うんどうかい',
  '涼しい': 'すずしい',
  '知らない人': 'しらないひと',
  'ついていく': 'ついていく',
  '楽しくない': 'たのしくない',
  '大人': 'おとな',
  '一緒': 'いっしょ',
  '正しく': 'ただしく',
  '触る': 'さわる',
  '知らせる': 'しらせる',
  '近づく': 'ちかづく',
  '暗い道': 'くらいみち',
  '歩く': 'あるく',
  '一人': 'ひとり',
  '走る': 'はしる',
  '栄養': 'えいよう',
  'たくさん': 'たくさん',
  '家族': 'かぞく',
  '病気': 'びょうき',
  'うるさい': 'うるさい',
  '静か': 'しずか',
  '遊び': 'あそび',
  '休ませる': 'やすませる',
  '頼まれる': 'たのまれる',
  'いやがる': 'いやがる',
  '逃げる': 'にげる',
  '積極的': 'せっきょくてき',
  '使った': 'つかった',
  'そのまま': 'そのまま',
  '片付ける': 'かたづける',
  '隠す': 'かくす',
  '元の場所': 'もとのばしょ',
  '出かける': 'でかける',
  '勝手に': 'かってに',
  '時間': 'じかん',
  'おじいちゃん': 'おじいちゃん',
  'おばあちゃん': 'おばあちゃん',
  '冷たい': 'つめたい',
  '優しい': 'やさしい',
  'お年寄り': 'おとしより',
  '接する': 'せっする',
  'おしゃべり': 'おしゃべり',
  '寝る': 'ねる',
  'きちんと': 'きちんと',
  'やってもらう': 'やってもらう',
  '自分': 'じぶん',
  '借りる': 'かりる',
  '返さない': 'かえさない',
  'ちゃんと': 'ちゃんと',
  '返す': 'かえす',
  '借りた': 'かりた',
  '必ず': 'かならず',
  '掃除': 'そうじ',
  'みんな': 'みんな',
  '隠れる': 'かくれる',
  '好きなもの': 'すきなもの',
  '食べる': 'たべる',
  '食べない': 'たべない',
  '捨てる': 'すてる',
  '決められた': 'きめられた',
  '場所': 'ばしょ',
  '折る': 'おる',
  '蹴る': 'ける',
  '水': 'みず',
  '出しっぱなし': 'だしっぱなし',
  '閉める': 'しめる',
  '電気': 'でんき',
  'つけっぱなし': 'つけっぱなし',
  'もったいない': 'もったいない',
  'かっこいい': 'かっこいい',
  '使わない': 'つかわない',
  '消す': 'けす',
  '虫': 'むし',
  '見つける': 'みつける',
  '殺す': 'ころす',
  'そっと': 'そっと',
  'しておく': 'しておく',
  'いじめる': 'いじめる',
  '小さな': 'ちいさな',
  '命': 'いのち',
  '遅れる': 'おくれる',
  '良い': 'よい',
  '守る': 'まもる',
  '忘れる': 'わすれる',
  '破る': 'やぶる',
  '体': 'からだ',
  '悪い': 'わるい',
  '関係ない': 'かんけいない',
  '健康的': 'けんこうてき',
  '生活': 'せいかつ',
  '元気': 'げんき',
  '一日': 'いちにち',
  '始める': 'はじめる',
  '本': 'ほん',
  '読む': 'よむ',
  '増える': 'ふえる',
  '想像力': 'そうぞうりょく',
  '育つ': 'そだつ',
  // 7歳向けで不足していた語彙を追加
  '夜': 'よる',
  '寝る前': 'ねるまえ',
  '歯': 'は',
  '菓子': 'かし',
  'お菓子': 'おかし',
  '外': 'そと',
  '遊ぶ': 'あそぶ',
  '意見': 'いけん',
  '違う': 'ちがう',
  '違う時': 'ちがうとき',
  '時': 'とき',
  '話し合う': 'はなしあう',
  // 7歳向け問題で特に必要な語彙（既存辞書にない確実なもののみ）
  '勇敢': 'ゆうかん',
  '探検': 'たんけん',
  '磁石': 'じしゃく',
  '蒸発': 'じょうはつ',
  '化石': 'かせき',
  'ともだちと': 'ともだちと',
  'けんかする': 'けんかする',
  'むしする': 'むしする',
  // スクリーンショットで発見された問題語彙を追加
  '桜が咲く': 'さくらがさく',
  '桜': 'さくら',
  '咲く': 'さく',
  'お手伝い': 'おてつだい',
  '頼まれた': 'たのまれた',
  '頼む': 'たのむ',
  '頼': 'たの',
  // 7歳テスト画面で発見された未習漢字を緊急対応
  '誕生日': 'たんじょうび',
  '誕生日プレゼント': 'たんじょうびプレゼント',
  'プレゼント': 'プレゼント',
  '友達が': 'ともだちが',
  'くれた': 'くれた',
  'くれた時': 'くれたとき',
  'うれしい': 'うれしい',
  'かなしい': 'かなしい',
  'おこる': 'おこる',
  // 継続して発見されている未習漢字を追加
  '遅れても': 'おくれても',
  '遅れて': 'おくれて',
  '遅': 'おく',
  '渡る': 'わたる',
  '渡': 'わた',
  // 問題番号・テスト関連の漢字対応（重複除去済み）
  '回答': 'かいとう',
  '正解': 'せいかい',
  '不正解': 'ふせいかい',
  // 常識テスト問題で頻出する語彙を追加
  '常識': 'じょうしき',
  '年齢': 'ねんれい',
  '適した': 'てきした',
  '表現': 'ひょうげん',
  '基': 'き'
};

/**
 * Get all allowed kanji characters for a given grade level and below
 */
export function getAllowedKanjiForGrade(gradeLevel: number): Set<string> {
  const allowedKanji = new Set<string>();
  
  for (let grade = 1; grade <= Math.min(gradeLevel, 6); grade++) {
    GRADE_KANJI[grade]?.forEach(kanji => allowedKanji.add(kanji));
  }
  
  return allowedKanji;
}

/**
 * Check if a character is a kanji character
 */
export function isKanji(char: string): boolean {
  const charCode = char.charCodeAt(0);
  return (charCode >= 0x4e00 && charCode <= 0x9faf) || // CJK Unified Ideographs
         (charCode >= 0x3400 && charCode <= 0x4dbf);   // CJK Extension A
}

/**
 * Check if a character is hiragana
 */
export function isHiragana(char: string): boolean {
  const charCode = char.charCodeAt(0);
  return charCode >= 0x3040 && charCode <= 0x309f;
}

/**
 * Check if a character is katakana
 */
export function isKatakana(char: string): boolean {
  const charCode = char.charCodeAt(0);
  return charCode >= 0x30a0 && charCode <= 0x30ff;
}

/**
 * Check if text contains only grade-appropriate kanji
 */
export function isTextAppropriateForGrade(text: string, gradeLevel: number): boolean {
  const allowedKanji = getAllowedKanjiForGrade(gradeLevel);
  
  for (const char of Array.from(text)) {
    if (isKanji(char) && !allowedKanji.has(char)) {
      return false;
    }
  }
  
  return true;
}

/**
 * Convert age to grade level (6 years = grade 1, 7 years = grade 2, etc.)
 */
export function ageToGradeLevel(age: number): number {
  if (age < 6) return 1;
  if (age <= 11) return age - 5; // 6 years = grade 1, 7 years = grade 2, etc.
  return 6; // Middle school and above can use all elementary kanji
}

/**
 * Filter text to be appropriate for a given grade level
 */
export function filterTextForGrade(text: string, options: KanjiFilterOptions): string {
  const { gradeLevel, allowHiragana = true, allowKatakana = true, strictMode = true } = options;
  
  // デバッグ用ログ
  console.log('🔧 filterTextForGrade called:', { text, gradeLevel, strictMode });
  
  if (!strictMode) {
    console.log('⚠️ strictMode is false, returning original text');
    return text; // Return original text if not in strict mode
  }
  
  let filteredText = text;
  
  // First, try to replace common kanji compounds with hiragana
  console.log('🔍 Starting KANJI_TO_HIRAGANA processing for:', filteredText);
  for (const [kanji, hiragana] of Object.entries(KANJI_TO_HIRAGANA)) {
    if (filteredText.includes(kanji)) {
      console.log(`📝 Found "${kanji}" in text, checking appropriateness...`);
      const kanjiAppropriate = Array.from(kanji).every(char => 
        !isKanji(char) || getAllowedKanjiForGrade(gradeLevel).has(char)
      );
      console.log(`📊 "${kanji}" appropriate for grade ${gradeLevel}?`, kanjiAppropriate);
      
      if (!kanjiAppropriate) {
        console.log(`🔄 Replacing "${kanji}" with "${hiragana}"`);
        filteredText = filteredText.replace(new RegExp(kanji, 'g'), hiragana);
        console.log(`✅ Text after replacement:`, filteredText);
      } else {
        console.log(`⏭️ Keeping "${kanji}" (appropriate for grade level)`);
      }
    }
  }
  
  // Then filter individual characters
  const allowedKanji = getAllowedKanjiForGrade(gradeLevel);
  let result = '';
  
  for (const char of Array.from(filteredText)) {
    if (isKanji(char)) {
      if (allowedKanji.has(char)) {
        result += char; // Keep appropriate kanji
      } else {
        // For inappropriate kanji, convert to hiragana reading
        // Enhanced with comprehensive readings
        const simpleReadings: { [key: string]: string } = {
          '桜': 'さくら',
          '頼': 'たの',
          '問': 'もん',
          '題': 'だい',
          '咲': 'さ',
          '季': 'き',
          '節': 'せつ',
          '春': 'はる',
          '夏': 'なつ',
          '秋': 'あき',
          '冬': 'ふゆ',
          '運': 'うん',
          '動': 'どう',
          '会': 'かい',
          '病': 'びょう',
          '薬': 'くすり',
          '危': 'き',
          '険': 'けん',
          '知': 'し',
          '暗': 'くら',
          '困': 'こま',
          '助': 'たす',
          '笑': 'わら',
          '泣': 'な',
          '怒': 'おこ',
          '悲': 'かな',
          '喜': 'よろこ',
          '楽': 'らく',
          '苦': 'く',
          '痛': 'いた',
          '寒': 'さむ',
          '暑': 'あつ',
          '涼': 'すず',
          '暖': 'あたた',
          '温': 'あたた',
          '冷': 'つめ',
          '熱': 'あつ',
          '冰': 'こおり',
          // 7歳テスト画面で発見された未習漢字の緊急対応
          '誕': 'たん',
          '生': 'せい',
          '遅': 'おく',
          '渡': 'わた',
          // 常識テスト問題で頻出の個別漢字を追加
          '常': 'じょう',
          '識': 'しき',
          '齢': 'れい',
          '適': 'てき',
          '表': 'ひょう',
          '現': 'げん',
          '基': 'き',
          '回': 'かい',
          '答': 'とう',
          '選': 'せん',
          '択': 'たく',
          '正': 'せい',
          '解': 'かい',
          '税': 'ぜい',
          '金': 'きん',
          '民': 'みん',
          '主': 'しゅ',
          '義': 'ぎ',
          '情': 'じょう',
          '報': 'ほう',
          '技': 'ぎ',
          '術': 'じゅつ',
          '科': 'か',
          '学': 'がく',
          '理': 'り',
          '由': 'ゆう',
          '原': 'げん',
          '因': 'いん',
          '結': 'けっ',
          '果': 'か',
          '影': 'えい',
          '響': 'きょう',
          '効': 'こう',
          '利': 'り',
          '益': 'えき',
          '損': 'そん',
          '失': 'しつ',
          '安': 'あん',
          '全': 'ぜん',
          '注': 'ちゅう',
          '意': 'い',
          '警': 'けい',
          '告': 'こく',
          '約': 'やく',
          '束': 'そく',
          '責': 'せき',
          '任': 'にん',
          '務': 'む',
          '権': 'けん',
          '自': 'じ',
          '平': 'へい',
          '等': 'とう',
          '公': 'こう',
          '法': 'ほう',
          '律': 'りつ',
          '制': 'せい',
          '度': 'ど'
        };
        
        result += simpleReadings[char] || char;
      }
    } else if (isHiragana(char) && allowHiragana) {
      result += char;
    } else if (isKatakana(char) && allowKatakana) {
      result += char;
    } else {
      result += char; // Keep other characters (punctuation, numbers, etc.)
    }
  }
  
  console.log('🎯 filterTextForGrade result:', { original: text, filtered: result });
  return result;
}

/**
 * Get reading difficulty score for text (0-10, higher = more difficult)
 */
export function getTextDifficulty(text: string): number {
  let kanjiCount = 0;
  let complexKanjiCount = 0;
  let totalChars = 0;
  
  const grade1Kanji = new Set(GRADE_KANJI[1] || []);
  const grade2Kanji = new Set(GRADE_KANJI[2] || []);
  const grade3Kanji = new Set(GRADE_KANJI[3] || []);
  
  for (const char of Array.from(text)) {
    if (isKanji(char)) {
      kanjiCount++;
      if (!grade1Kanji.has(char) && !grade2Kanji.has(char) && !grade3Kanji.has(char)) {
        complexKanjiCount++;
      }
    }
    if (char.trim()) totalChars++;
  }
  
  if (totalChars === 0) return 0;
  
  const kanjiRatio = kanjiCount / totalChars;
  const complexKanjiRatio = complexKanjiCount / totalChars;
  
  // Calculate difficulty score
  let difficulty = 0;
  difficulty += kanjiRatio * 5; // Base kanji presence
  difficulty += complexKanjiRatio * 5; // Complex kanji penalty
  
  return Math.min(10, Math.max(0, Math.round(difficulty)));
}

/**
 * Generate age-appropriate alternative text suggestions
 */
export function getSimpleAlternatives(text: string, targetGrade: number): string[] {
  const alternatives: string[] = [text]; // Include original
  
  // Try filtering with different strictness levels
  const strictFiltered = filterTextForGrade(text, {
    gradeLevel: targetGrade,
    allowHiragana: true,
    allowKatakana: true,
    strictMode: true
  });
  
  if (strictFiltered !== text) {
    alternatives.push(strictFiltered);
  }
  
  // Try with one grade higher for slightly more advanced option
  if (targetGrade < 6) {
    const relaxedFiltered = filterTextForGrade(text, {
      gradeLevel: targetGrade + 1,
      allowHiragana: true,
      allowKatakana: true,
      strictMode: true
    });
    
    if (relaxedFiltered !== text && relaxedFiltered !== strictFiltered) {
      alternatives.push(relaxedFiltered);
    }
  }
  
  return Array.from(new Set(alternatives)); // Remove duplicates
}